# syntax=docker/dockerfile:1

ARG RUBY_VERSION=3.4.2
FROM ruby:$RUBY_VERSION-slim

RUN apt-get update && apt-get install -y vim

WORKDIR /rails

# Install dev dependencies
RUN apt-get update -qq && \
    apt-get install -y --no-install-recommends \
      build-essential \
      curl \
      git \
      libpq-dev \
      libvips-dev \
      nodejs \
      sqlite3 \
      yarn \
      libsqlite3-dev \
      libyaml-dev && \
    rm -rf /var/lib/apt/lists/*

# Set environment variables for development
ENV RAILS_ENV=development \
    BUNDLE_PATH=/usr/local/bundle \
    BUNDLE_WITHOUT=production:test

# Install gems
COPY Gemfile Gemfile.lock ./
RUN bundle install

# Copy the rest of the app
COPY . .

# Install JS dependencies (if using jsbundling-rails or similar)
RUN yarn install --check-files || true

# Ensure tmp dirs exist
RUN mkdir -p tmp/pids tmp/sockets log

CMD ["./bin/dev"]
